<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Checkout | Fashion Shop</title>
    <link rel="stylesheet" href="style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      .checkout-container {
        max-width: 900px;
        margin: 50px auto;
        background: white;
        padding: 40px;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 40px;
      }

      /* á•áŸ’á“áŸ‚á€ QR Code */
      .payment-section {
        text-align: center;
        border-right: 1px solid #eee;
        padding-right: 40px;
      }
      .qr-box {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        margin: 20px 0;
        display: inline-block;
        border: 2px dashed #d35400;
      }
      .qr-box img {
        width: 200px;
        height: 200px;
        display: block;
      }

      /* á•áŸ’á“áŸ‚á€ Order Summary */
      .order-summary h3 {
        border-bottom: 2px solid #2c3e50;
        padding-bottom: 10px;
        margin-bottom: 20px;
      }

      /* ğŸ”¥ Style áŸá˜áŸ’ášá¶á”áŸ‹á”á‰áŸ’á‡á¸á‘áŸ†á“á·á‰ááŸ’á˜á¸ ğŸ”¥ */
      .order-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #f0f0f0;
      }
      .item-info {
        flex: 1;
      }
      .item-name {
        font-weight: bold;
        color: #333;
        display: block;
      }
      .item-price {
        color: #777;
        font-size: 0.9rem;
      }

      .item-controls {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .qty-btn {
        background: #eee;
        border: none;
        width: 30px;
        height: 30px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        color: #333;
        transition: 0.2s;
      }
      .qty-btn:hover {
        background: #ddd;
      }
      .remove-btn {
        background: #ffcccc;
        color: #c0392b;
        border: none;
        width: 30px;
        height: 30px;
        border-radius: 5px;
        cursor: pointer;
      }
      .remove-btn:hover {
        background: #ffaaaa;
      }

      /* áá˜áŸ’á›áŸƒáŸášá»á” */
      .total-price {
        font-size: 1.5rem;
        font-weight: bold;
        color: #d35400;
        margin-top: 20px;
        border-top: 2px solid #eee;
        padding-top: 15px;
        display: flex;
        justify-content: space-between;
      }

      .status-badge {
        margin-top: 10px;
        padding: 8px 15px;
        background: #fff3cd;
        color: #856404;
        border-radius: 20px;
        font-weight: bold;
        display: inline-block;
      }
      .btn-simulate {
        margin-top: 20px;
        background: #2c3e50;
        color: white;
        padding: 10px 20px;
        text-decoration: none;
        border-radius: 5px;
        display: inline-block;
        font-size: 0.9rem;
      }

      @media (max-width: 768px) {
        .checkout-container {
          grid-template-columns: 1fr;
          border-right: none;
        }
        .payment-section {
          border-right: none;
          border-bottom: 1px solid #eee;
          padding-bottom: 30px;
          padding-right: 0;
        }
      }
    </style>
  </head>
  <body>
    <nav class="navbar">
      <div class="logo">Fashion Shop</div>
      <ul class="nav-links">
        <li><a href="index.html">Home</a></li>
      </ul>
    </nav>

    <div class="checkout-container">
      <div class="payment-section">
        <h2><i class="fas fa-qrcode"></i> Scan to Pay</h2>
        <p>Scan to pay via mobile banking</p>

        <div class="qr-box" id="qr-container">
          <img id="qr-img" src="" alt="Generating QR..." />
        </div>

        <div id="payment-status">
          <span class="status-badge"
            ><i class="fas fa-spinner fa-spin"></i> Waiting for payment...</span
          >
        </div>

        <a id="mobile-link" href="#" target="_blank" class="btn-simulate">
          <i class="fas fa-mobile-alt"></i> Open Mobile Simulator
        </a>
      </div>

      <div class="order-summary">
        <h3>Your Order</h3>
        <div id="order-items"></div>

        <div class="total-price">
          <span>Total:</span>
          <span id="total-amount">$0.00</span>
        </div>

        <div style="margin-top: 20px; font-size: 0.9rem; color: #777">
          <p>Order ID: <span id="display-order-id">...</span></p>
        </div>
      </div>
    </div>

    <script>
      // âœ… API URL
      const API_URL = "/api";

      let currentOrderId = "";
      let currentTotal = 0;
      let pollingInterval;

      window.onload = function () {
        currentOrderId = "ORD-" + Math.floor(100000 + Math.random() * 900000);
        document.getElementById("display-order-id").innerText = currentOrderId;

        renderOrderList();
        startPolling();
      };

      // ğŸ”¥ á˜á»áá„á¶ášá”á„áŸ’á á¶á‰á”á‰áŸ’á‡á¸á‘áŸ†á“á·á‰ (á€áŸ‚áŸá˜áŸ’ášá½á›á”áŸ’ášá¾ Index) ğŸ”¥
      function renderOrderList() {
        const cart = JSON.parse(localStorage.getItem("shoppingCart")) || [];
        const itemsContainer = document.getElementById("order-items");

        if (cart.length === 0) {
          alert("Cart is empty! Redirecting...");
          window.location.href = "index.html";
          return;
        }

        currentTotal = cart.reduce(
          (sum, item) => sum + item.price * item.qty,
          0,
        );
        document.getElementById("total-amount").innerText =
          "$" + currentTotal.toFixed(2);

        // ğŸ‘‰ á€áŸ‚ááŸ’ášá„áŸ‹á“áŸáŸ‡áŸ– ááŸ‚á˜ index á€áŸ’á“á»á„ map áŠá¾á˜áŸ’á”á¸áŸá˜áŸ’á‚á¶á›áŸ‹á‘á¸áá¶áŸ†á„
        itemsContainer.innerHTML = cart
          .map(
            (item, index) => `
                <div class="order-item">
                    <div class="item-info">
                        <span class="item-name">${item.name}</span>
                        <span class="item-price">$${item.price} x ${item.qty}</span>
                    </div>
                    <div class="item-controls">
                        <button class="qty-btn" onclick="updateQty(${index}, -1)">-</button>
                        
                        <span style="font-weight:bold; min-width:20px; text-align:center;">${item.qty}</span>
                        
                        <button class="qty-btn" onclick="updateQty(${index}, 1)">+</button>
                        
                        <button class="remove-btn" onclick="removeItem(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `,
          )
          .join("");

        generateQRCode();
      }

      // ğŸ”¥ á˜á»áá„á¶ášá€áŸ‚á…áŸ†á“á½á“ (á€áŸ‚á”áŸ’ášá¾ Index) ğŸ”¥
      function updateQty(index, change) {
        let cart = JSON.parse(localStorage.getItem("shoppingCart")) || [];

        // á…á¶á”áŸ‹á™á€áá¶á˜á›áŸáášáŸ€á„ (á’á¶á“á¶áá¶á…áŸ†áá½ áŸ¡áŸ áŸ %)
        if (cart[index]) {
          cart[index].qty += change;

          // á”á¾áŠá€áŠá›áŸ‹ 0 á‚áºá›á»á”á…áŸ„á› (áŠáŸ„á™á”áŸ’ášá¾ splice áá¶á˜ index)
          if (cart[index].qty <= 0) {
            cart.splice(index, 1);
          }
        }

        localStorage.setItem("shoppingCart", JSON.stringify(cart));
        renderOrderList();
      }

      // ğŸ”¥ á˜á»áá„á¶ášá›á»á”á…áŸ„á› (á€áŸ‚á”áŸ’ášá¾ Index) ğŸ”¥
      function removeItem(index) {
        if (!confirm("Are you sure you want to remove this item?")) return;

        let cart = JSON.parse(localStorage.getItem("shoppingCart")) || [];

        // á›á»á”áá¶á˜á›áŸáášáŸ€á„
        cart.splice(index, 1);

        localStorage.setItem("shoppingCart", JSON.stringify(cart));
        renderOrderList();
      }

      function generateQRCode() {
        const currentDomain = window.location.origin;
        const paymentData = `${currentDomain}/mobile-pay.html?id=${currentOrderId}&amount=${currentTotal.toFixed(2)}`;
        const qrApi = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(paymentData)}`;

        document.getElementById("qr-img").src = qrApi;
        document.getElementById("mobile-link").href = paymentData;
      }

      async function startPolling() {
        if (pollingInterval) clearInterval(pollingInterval);

        pollingInterval = setInterval(async () => {
          try {
            const res = await fetch(
              `${API_URL}/check-status/${currentOrderId}`,
            );
            const data = await res.json();

            if (data.status === "SUCCESS") {
              clearInterval(pollingInterval);
              document.getElementById("qr-container").innerHTML = `
                            <div style="color: green; font-size: 1.5rem; font-weight: bold; padding: 50px 0;">
                                <i class="fas fa-check-circle" style="font-size: 3rem; margin-bottom: 10px;"></i><br>
                                Payment Successful!
                            </div>
                        `;
              document.getElementById("payment-status").innerHTML =
                `<span class="status-badge" style="background:#d4edda; color:#155724;">Paid Successfully</span>`;
              localStorage.removeItem("shoppingCart");
              setTimeout(() => {
                window.location.href = "index.html";
              }, 3000);
            }
          } catch (error) {
            console.error("Polling error:", error);
          }
        }, 2000);
      }
    </script>
  </body>
</html>
